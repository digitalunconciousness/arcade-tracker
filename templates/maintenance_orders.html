{% extends "base.html" %}

{% block content %}
<h1>🔧 Maintenance Orders</h1>

<div style="margin: 20px 0;">
    <button onclick="showTab('open')" id="openTab" class="btn btn-warning" style="margin-right: 10px;">🚨 Open Orders ({{ open_records|length }})</button>
    <button onclick="showTab('closed')" id="closedTab" class="btn" style="background: #6c757d; margin-right: 10px;">✅ Closed Orders ({{ closed_records|length }})</button>
    <button onclick="showTab('all')" id="allTab" class="btn" style="background: var(--neon-cyan);">📋 All Orders ({{ all_records|length }})</button>
</div>

<!-- Open Orders Tab -->
<div id="openOrders" class="maintenance-tab">
    <h2>🚨 Open Maintenance Orders</h2>
    {% if open_records %}
    <table class="table" id="openOrdersTable" style="--table-cell-padding: 8px 8px;">
<style>
#openOrdersTable th, #closedOrdersTable th, #allOrdersTable th {
    padding: 10px 8px !important;
    font-size: 12px;
}
#openOrdersTable td, #closedOrdersTable td, #allOrdersTable td {
    padding: 6px 8px !important;
    font-size: 13px;
    vertical-align: middle;
}
</style>
        <thead>
            <tr>
                <th onclick="sortMaintenanceTable(0, 'openOrdersTable')" style="cursor: pointer;" title="Click to sort">Status ↕️</th>
                <th onclick="sortMaintenanceTable(1, 'openOrdersTable')" style="cursor: pointer;" title="Click to sort">Game ↕️</th>
                <th onclick="sortMaintenanceTable(2, 'openOrdersTable')" style="cursor: pointer;" title="Click to sort">Issue ↕️</th>
                <th onclick="sortMaintenanceTable(3, 'openOrdersTable')" style="cursor: pointer;" title="Click to sort">Reported ↕️</th>
                <th onclick="sortMaintenanceTable(4, 'openOrdersTable')" style="cursor: pointer;" title="Click to sort">Technician ↕️</th>
                <th onclick="sortMaintenanceTable(5, 'openOrdersTable')" style="cursor: pointer;" title="Click to sort">Cost ↕️</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in open_records %}
            <tr style="height: 45px; cursor: pointer;" onclick="window.location='{{ url_for('maintenance_detail', record_id=record.id) }}';">
                <td>
                    {% if record.status == 'Open' %}
                        <span style="color: #ff4444; font-weight: bold;">🔴 Open</span>
                    {% elif record.status == 'In_Progress' %}
                        <span style="color: #ffaa00; font-weight: bold;">🟡 In Progress</span>
                    {% endif %}
                </td>
                <td>{% if record.game_id %}<a href="{{ url_for('game_detail', game_id=record.game_id) }}">{{ record.game.name }}</a>{% else %}<span style="color: var(--neon-purple); font-style: italic;">General Maintenance</span>{% endif %}</td>
                <td>{{ record.issue_description[:50] }}{% if record.issue_description|length > 50 %}...{% endif %}</td>
                <td>{{ record.date_reported.strftime('%Y-%m-%d') }}</td>
                <td>{{ record.technician or 'Not Assigned' }}</td>
                <td>${{ "%.2f"|format(record.cost or 0) }}</td>
                <td style="padding: 8px; white-space: nowrap;" onclick="event.stopPropagation();">
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <a href="{{ url_for('maintenance_detail', record_id=record.id) }}" class="btn" style="background: var(--neon-cyan); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center; color: black;">View</a>
                        {% if current_user.has_role('operator') %}
                            <a href="{{ url_for('maintenance_photos', maintenance_id=record.id) }}" class="btn" style="background: var(--neon-pink); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center;">Photos</a>
                        {% endif %}
                        <a href="{{ url_for('update_maintenance', record_id=record.id) }}" class="btn" style="background: var(--neon-purple); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 50px; text-align: center;">Update</a>
                        <button onclick="openCloseModal({{ record.id }}, '{{ (record.game.name if record.game else 'General Maintenance')|replace("'", "\\'") }}', '{{ record.issue_description|replace("'", "\\'") }}')" 
                                class="btn btn-success" style="font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center;">Close</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--neon-green);">🎉 No open maintenance orders! All systems operational.</p>
    {% endif %}
</div>

<!-- Closed Orders Tab -->
<div id="closedOrders" class="maintenance-tab" style="display: none;">
    <h2>✅ Closed Maintenance Orders</h2>
    {% if closed_records %}
    <table class="table" id="closedOrdersTable">
        <thead>
            <tr>
                <th onclick="sortMaintenanceTable(0, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Status ↕️</th>
                <th onclick="sortMaintenanceTable(1, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Game ↕️</th>
                <th onclick="sortMaintenanceTable(2, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Issue ↕️</th>
                <th onclick="sortMaintenanceTable(3, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Reported ↕️</th>
                <th onclick="sortMaintenanceTable(4, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Fixed ↕️</th>
                <th onclick="sortMaintenanceTable(5, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Technician ↕️</th>
                <th onclick="sortMaintenanceTable(6, 'closedOrdersTable')" style="cursor: pointer;" title="Click to sort">Cost ↕️</th>
                <th>Fix Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in closed_records %}
            <tr style="height: 45px; cursor: pointer;" onclick="window.location='{{ url_for('maintenance_detail', record_id=record.id) }}';">
                <td>
                    {% if record.status == 'Fixed' %}
                        <span style="color: var(--neon-green); font-weight: bold;">✅ Fixed</span>
                    {% elif record.status == 'Deferred' %}
                        <span style="color: #888; font-weight: bold;">⏸️ Deferred</span>
                    {% endif %}
                </td>
                <td>{% if record.game_id %}<a href="{{ url_for('game_detail', game_id=record.game_id) }}">{{ record.game.name }}</a>{% else %}<span style="color: var(--neon-purple); font-style: italic;">General Maintenance</span>{% endif %}</td>
                <td>{{ record.issue_description[:50] }}{% if record.issue_description|length > 50 %}...{% endif %}</td>
                <td>{{ record.date_reported.strftime('%Y-%m-%d') }}</td>
                <td>{{ record.date_fixed.strftime('%Y-%m-%d') if record.date_fixed else 'N/A' }}</td>
                <td>{{ record.technician or 'N/A' }}</td>
                <td>${{ "%.2f"|format(record.cost or 0) }}</td>
                <td>{{ record.fix_description[:40] if record.fix_description else 'N/A' }}{% if record.fix_description and record.fix_description|length > 40 %}...{% endif %}</td>
                <td style="padding: 8px; white-space: nowrap;" onclick="event.stopPropagation();">
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <a href="{{ url_for('maintenance_detail', record_id=record.id) }}" class="btn" style="background: var(--neon-cyan); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center; color: black;">View</a>
                        {% if current_user.has_role('operator') %}
                            <a href="{{ url_for('maintenance_photos', maintenance_id=record.id) }}" class="btn" style="background: var(--neon-pink); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center;">Photos</a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No closed maintenance orders yet.</p>
    {% endif %}
</div>

<!-- All Orders Tab -->
<div id="allOrders" class="maintenance-tab" style="display: none;">
    <h2>📋 All Maintenance Orders</h2>
    {% if all_records %}
    <table class="table" id="allOrdersTable">
        <thead>
            <tr>
                <th onclick="sortMaintenanceTable(0, 'allOrdersTable')" style="cursor: pointer;" title="Click to sort">Status ↕️</th>
                <th onclick="sortMaintenanceTable(1, 'allOrdersTable')" style="cursor: pointer;" title="Click to sort">Game ↕️</th>
                <th onclick="sortMaintenanceTable(2, 'allOrdersTable')" style="cursor: pointer;" title="Click to sort">Issue ↕️</th>
                <th onclick="sortMaintenanceTable(3, 'allOrdersTable')" style="cursor: pointer;" title="Click to sort">Reported ↕️</th>
                <th onclick="sortMaintenanceTable(4, 'allOrdersTable')" style="cursor: pointer;" title="Click to sort">Technician ↕️</th>
                <th onclick="sortMaintenanceTable(5, 'allOrdersTable')" style="cursor: pointer;" title="Click to sort">Cost ↕️</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in all_records %}
            <tr style="height: 45px; cursor: pointer;" onclick="window.location='{{ url_for('maintenance_detail', record_id=record.id) }}';">
                <td>
                    {% if record.status == 'Open' %}
                        <span style="color: #ff4444; font-weight: bold;">🔴 Open</span>
                    {% elif record.status == 'In_Progress' %}
                        <span style="color: #ffaa00; font-weight: bold;">🟡 In Progress</span>
                    {% elif record.status == 'Fixed' %}
                        <span style="color: var(--neon-green); font-weight: bold;">✅ Fixed</span>
                    {% elif record.status == 'Deferred' %}
                        <span style="color: #888; font-weight: bold;">⏸️ Deferred</span>
                    {% endif %}
                </td>
                <td>{% if record.game_id %}<a href="{{ url_for('game_detail', game_id=record.game_id) }}">{{ record.game.name }}</a>{% else %}<span style="color: var(--neon-purple); font-style: italic;">General Maintenance</span>{% endif %}</td>
                <td>{{ record.issue_description[:50] }}{% if record.issue_description|length > 50 %}...{% endif %}</td>
                <td>{{ record.date_reported.strftime('%Y-%m-%d') }}</td>
                <td>{{ record.technician or 'Not Assigned' }}</td>
                <td>${{ "%.2f"|format(record.cost or 0) }}</td>
                <td style="padding: 8px; white-space: nowrap;" onclick="event.stopPropagation();">
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <a href="{{ url_for('maintenance_detail', record_id=record.id) }}" class="btn" style="background: var(--neon-cyan); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center; color: black;">View</a>
                        {% if current_user.has_role('operator') %}
                            <a href="{{ url_for('maintenance_photos', maintenance_id=record.id) }}" class="btn" style="background: var(--neon-pink); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center;">Photos</a>
                        {% endif %}
                        {% if record.status in ['Open', 'In_Progress'] %}
                            <a href="{{ url_for('update_maintenance', record_id=record.id) }}" class="btn" style="background: var(--neon-purple); font-size: 10px; padding: 4px 8px; margin: 0; min-width: 50px; text-align: center;">Update</a>
                            <button onclick="openCloseModal({{ record.id }}, '{{ (record.game.name if record.game else 'General Maintenance')|replace("'", "\\'") }}', '{{ record.issue_description|replace("'", "\\'") }}')" 
                                    class="btn btn-success" style="font-size: 10px; padding: 4px 8px; margin: 0; min-width: 45px; text-align: center;">Close</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No maintenance orders yet.</p>
    {% endif %}
</div>

<!-- Close Maintenance Modal -->
<div id="closeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--dark-card); padding: 30px; border-radius: 8px; border: 2px solid var(--neon-cyan); max-width: 500px; width: 90%;">
        <h3>🔧 Close Maintenance Order</h3>
        <p><strong>Game:</strong> <span id="modalGameName"></span></p>
        <p><strong>Issue:</strong> <span id="modalIssue"></span></p>
        
        <form id="closeForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-group">
                <label for="modalStatus">Final Status *</label>
                <select id="modalStatus" name="status" required>
                    <option value="Fixed">✅ Fixed</option>
                    <option value="Deferred">⏸️ Deferred</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="modalFixDescription">Fix Description</label>
                <textarea id="modalFixDescription" name="fix_description" rows="3" placeholder="Describe what was done to fix the issue..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="modalTechnician">Technician</label>
                <input type="text" id="modalTechnician" name="technician" placeholder="Who fixed this?">
            </div>
            
            <div class="form-group">
                <label for="modalCost">Cost ($)</label>
                <input type="number" id="modalCost" name="cost" step="0.01" min="0" placeholder="0.00">
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" onclick="closeCloseModal()" class="btn" style="background: #6c757d; margin-right: 10px;">Cancel</button>
                <button type="submit" class="btn btn-success">💾 Close Order</button>
            </div>
        </form>
    </div>
</div>

<script>
let sortDirection = {};

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.maintenance-tab').forEach(tab => tab.style.display = 'none');
    
    // Remove active class from all buttons
    const buttons = [document.getElementById('openTab'), document.getElementById('closedTab'), document.getElementById('allTab')];
    buttons.forEach(btn => {
        btn.className = 'btn';
        btn.style.background = '#6c757d';
    });
    
    // Show selected tab and highlight button
    if (tabName === 'open') {
        document.getElementById('openOrders').style.display = 'block';
        document.getElementById('openTab').className = 'btn btn-warning';
        document.getElementById('openTab').style.background = '';
    } else if (tabName === 'closed') {
        document.getElementById('closedOrders').style.display = 'block';
        document.getElementById('closedTab').style.background = 'var(--neon-green)';
    } else if (tabName === 'all') {
        document.getElementById('allOrders').style.display = 'block';
        document.getElementById('allTab').style.background = 'var(--neon-cyan)';
    }
}

function sortMaintenanceTable(columnIndex, tableId) {
    const table = document.getElementById(tableId);
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    const sortKey = tableId + '_' + columnIndex;
    sortDirection[sortKey] = sortDirection[sortKey] === 'asc' ? 'desc' : 'asc';
    const isAscending = sortDirection[sortKey] === 'asc';
    
    rows.sort((a, b) => {
        let aValue = a.getElementsByTagName('td')[columnIndex].textContent.trim();
        let bValue = b.getElementsByTagName('td')[columnIndex].textContent.trim();
        
        // Handle date columns
        if (columnIndex === 3 || columnIndex === 4) {
            aValue = new Date(aValue === 'N/A' ? '1900-01-01' : aValue);
            bValue = new Date(bValue === 'N/A' ? '1900-01-01' : bValue);
            return isAscending ? aValue - bValue : bValue - aValue;
        }
        
        // Handle cost column
        if (columnIndex === 5 || columnIndex === 6) {
            aValue = parseFloat(aValue.replace(', '')) || 0;
            bValue = parseFloat(bValue.replace(', '')) || 0;
            return isAscending ? aValue - bValue : bValue - aValue;
        }
        
        // String sorting
        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
    });
    
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update header
    updateMaintenanceHeaders(columnIndex, isAscending, tableId);
}

function updateMaintenanceHeaders(sortedColumn, isAscending, tableId) {
    const headers = document.querySelectorAll(`#${tableId} th[onclick]`);
    headers.forEach((header, index) => {
        const baseText = header.textContent.replace(' ↕️', '').replace(' ↑', '').replace(' ↓', '');
        if (index === sortedColumn) {
            header.textContent = baseText + (isAscending ? ' ↑' : ' ↓');
            header.style.color = 'var(--neon-cyan)';
        } else {
            header.textContent = baseText + ' ↕️';
            header.style.color = '';
        }
    });
}

function openCloseModal(maintenanceId, gameName, issue) {
    document.getElementById('modalGameName').textContent = gameName;
    document.getElementById('modalIssue').textContent = issue;
    document.getElementById('closeForm').action = `/close_maintenance/${maintenanceId}`;
    document.getElementById('closeModal').style.display = 'block';
}

function closeCloseModal() {
    document.getElementById('closeModal').style.display = 'none';
}

// Initialize with open orders tab when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        showTab('open');
    });
} else {
    showTab('open');
}
</script>
{% endblock %}
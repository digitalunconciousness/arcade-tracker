{% extends "base.html" %}

{% block content %}
<h1>{{ game.name }}</h1>

{% if game.image_filename %}
<div style="text-align: center; margin: 20px 0;">
    <img src="{{ url_for('static', filename='uploads/' + game.image_filename) }}" 
         alt="{{ game.name }} Cabinet" 
         style="max-width: 300px; max-height: 400px; border-radius: 8px; border: 2px solid var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
</div>
{% endif %}

<div style="display: flex; gap: 20px; margin: 20px 0;">
    <div style="flex: 2;">
        <h2>Game Information</h2>
        <p><strong>Manufacturer:</strong> {{ game.manufacturer or 'N/A' }}</p>
        <p><strong>Year:</strong> {{ game.year or 'N/A' }}</p>
        <p><strong>Genre:</strong> {{ game.genre or 'N/A' }}</p>
        <p><strong>Location:</strong> {{ game.location }}</p>
        {% if game.location == 'Floor' and game.floor_position %}
        <p><strong>Floor Position:</strong> {{ game.floor_position }}</p>
        {% elif game.location == 'Warehouse' and game.warehouse_section %}
        <p><strong>Warehouse Section:</strong> {{ game.warehouse_section }}</p>
        {% endif %}
        <p><strong>Status:</strong> 
            <span style="color: {{ 'green' if game.status == 'Working' else 'red' if game.status == 'Not_Working' else 'orange' }}">
                {{ game.status.replace('_', ' ') }}
            </span>
        </p>
        <p><strong>Coin Counter Status:</strong> 
            <span style="color: {{ 'green' if game.counter_status == 'Working' else 'red' if game.counter_status == 'Broken_Counter' else 'orange' }}">
                {{ game.counter_status.replace('_', ' ') }}
            </span>
        </p>
        {% if game.counter_notes %}
        <p><strong>Counter Notes:</strong> {{ game.counter_notes }}</p>
        {% endif %}
        <p><strong>Date Added:</strong> {{ game.date_added.strftime('%Y-%m-%d') }}</p>
        <p><strong>Total Plays:</strong> {{ game.total_plays }}</p>
        {% if current_user.has_role('manager') %}
        <p><strong>Total Revenue:</strong> ${{ "%.2f"|format(game.total_revenue) }}</p>
        <p><strong>Revenue Per Play:</strong> ${{ "%.2f"|format(game.coins_per_play) }}</p>
        {% if game.date_added %}
        <p><strong>Daily Revenue Average:</strong> ${{ "%.2f"|format(game.total_revenue / ((today() - game.date_added.date()).days or 1)) }}</p>
        {% endif %}
        <p><strong>Top Rankings:</strong> Top 5 ({{ game.times_in_top_5 }} times), Top 10 ({{ game.times_in_top_10 }} times)</p>
        {% endif %}
        {% if game.notes %}
        <p><strong>Notes:</strong> {{ game.notes }}</p>
        {% endif %}
    </div>
    
    <div style="flex: 1;">
        {% if current_user.has_role('manager') %}
            <a href="{{ url_for('record_plays', game_id=game.id) }}" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">üí∞ Record New Plays</a>
        {% endif %}
        <a href="{{ url_for('maintenance', game_id=game.id) }}" class="btn btn-warning" style="width: 100%; margin-bottom: 10px;">üîß Add Maintenance</a>
        {% if current_user.has_role('manager') %}
            <a href="{{ url_for('edit_game', game_id=game.id) }}" class="btn" style="background: var(--neon-purple); width: 100%; margin-bottom: 10px;">‚úèÔ∏è Edit Game</a>
        {% endif %}
        <a href="{{ url_for('games_list') }}" class="btn" style="width: 100%;">Back to All Games</a>
    </div>
</div>

{% if current_user.has_role('manager') %}
<div style="display: flex; gap: 40px; margin: 30px 0;">
{% else %}
<div style="margin: 30px 0;">
{% endif %}
    <div style="flex: 1;">
        <h2>Recent Play Records</h2>
        {% if recent_records %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Plays</th>
                    {% if current_user.has_role('manager') %}<th>Revenue</th>{% endif %}
                    <th>Notes</th>
                    {% if current_user.has_role('manager') %}<th>Action</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for record in recent_records %}
                <tr>
                    <td>{{ record.date_recorded.strftime('%Y-%m-%d') }}</td>
                    <td>{{ record.plays_count }}</td>
                    {% if current_user.has_role('manager') %}<td>${{ "%.2f"|format(record.revenue) }}</td>{% endif %}
                    <td>{{ record.notes or '-' }}</td>
                    {% if current_user.has_role('manager') %}
                    <td>
                        <form method="POST" action="{{ url_for('delete_play_record', record_id=record.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this play record?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn" style="background: var(--danger); padding: 5px 10px; font-size: 0.9em;">üóëÔ∏è</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        {% if current_user.has_role('manager') %}
            {% if can_add_baseline %}
            <div style="background: rgba(0, 255, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--neon-cyan); margin-bottom: 15px;">
                <h3 style="margin-top: 0;">Set Baseline Coin Count</h3>
                <form method="POST" action="{{ url_for('add_baseline', game_id=game.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label for="baseline_coin_count">Initial Coin Count:</label>
                            <input type="number" name="baseline_coin_count" id="baseline_coin_count" min="0" value="0" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--neon-cyan); background: rgba(0,0,0,0.3); color: var(--neon-cyan);">
                        </div>
                        <button type="submit" class="btn btn-success">Set Baseline</button>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: var(--text-muted);">Set the current coin counter reading before recording plays.</p>
                </form>
            </div>
            {% endif %}
            <p>No play records yet. <a href="{{ url_for('record_plays', game_id=game.id) }}">Record the first plays!</a></p>
        {% else %}
            <p>No play records yet.</p>
        {% endif %}
        {% endif %}
    </div>
    {% if current_user.has_role('manager') %}
    <div style="flex: 1;">
        <h2>Maintenance History</h2>
        {% if maintenance_records %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Issue</th>
                    <th>Status</th>
                    <th>Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for record in maintenance_records %}
                <tr>
                    <td>{{ record.date_reported.strftime('%Y-%m-%d') }}</td>
                    <td>{{ record.issue_description[:30] }}{% if record.issue_description|length > 30 %}...{% endif %}</td>
                    <td>
                        <span style="color: {{ 'green' if record.status == 'Fixed' else 'red' if record.status == 'Open' else 'orange' }}">
                            {{ record.status.replace('_', ' ') }}
                        </span>
                    </td>
                    <td>${{ "%.2f"|format(record.cost or 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No maintenance records yet. <a href="{{ url_for('maintenance', game_id=game.id) }}">Add maintenance record!</a></p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

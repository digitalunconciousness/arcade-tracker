{% extends "base.html" %}

{% block title %}Graphs - Arcade Tracker{% endblock %}

{% block content %}
<h1 class="glitch" data-text="SYSTEM ANALYTICS">SYSTEM ANALYTICS</h1>

<div class="stats">
    <div class="stat-card">
        <span class="stat-number">{{ total_games }}</span>
        <div class="stat-label">Total Games</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ total_plays }}</span>
        <div class="stat-label">Total Plays</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">${{ "%.2f"|format(total_revenue) }}</span>
        <div class="stat-label">Total Revenue</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ floor_games|length }}</span>
        <div class="stat-label">Floor Games</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
    <!-- Daily Revenue Chart -->
    <div class="card">
        <h2>‚ö° Daily Revenue Trend</h2>
        <canvas id="dailyRevenueChart" width="400" height="300"></canvas>
    </div>

    <!-- Top Performers Chart -->
    <div class="card">
        <h2>üéØ Top Performers</h2>
        <canvas id="topPerformersChart" width="400" height="300"></canvas>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
    <!-- Game Status Distribution -->
    <div class="card">
        <h2>üîß System Status</h2>
        <canvas id="statusChart" width="400" height="300"></canvas>
    </div>

    <!-- Location Distribution -->
    <div class="card">
        <h2>üìç Location Distribution</h2>
        <canvas id="locationChart" width="400" height="300"></canvas>
    </div>
</div>

    <div class="card">
    <h2>üí∞ Revenue Over/Under Analysis</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        {% for game in all_games %}
            {% if game.status in ['Operational', 'operational'] %}
                {% set days_active = ((today() - game.date_added.date()).days or 1) %}
                {% set daily_avg = game.total_revenue / days_active %}
                {% set last_record = game.play_records|last %}
                {% if last_record %}
                    {% set last_revenue = last_record.revenue %}
                    {% set difference = last_revenue - daily_avg %}
                    {% set percentage = ((difference / daily_avg) * 100) if daily_avg > 0 else 0 %}
                    
                    <div class="stat-card" style="text-align: left;">
                        <h3 style="margin-top: 0; color: var(--neon-cyan);">{{ game.name }}</h3>
                        <div style="margin: 10px 0;">
                            <strong>Daily Average:</strong> ${{ "%.2f"|format(daily_avg) }}
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Last Record:</strong> ${{ "%.2f"|format(last_revenue) }}
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Difference:</strong> 
                            {% if difference > 0 %}
                                <span class="revenue-indicator revenue-over">
                                    +${{ "%.2f"|format(difference) }} ({{ "%.1f"|format(percentage) }}%)
                                </span>
                            {% elif difference < 0 %}
                                <span class="revenue-indicator revenue-under">
                                    ${{ "%.2f"|format(difference) }} ({{ "%.1f"|format(percentage) }}%)
                                </span>
                            {% else %}
                                <span class="revenue-indicator revenue-neutral">
                                    On Target
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
    </div>
</div>

<script>
// Cyberpunk chart styling
const chartOptions = {
    plugins: {
        legend: {
            labels: {
                color: '#00ffff',
                font: {
                    family: 'Share Tech Mono'
                }
            }
        }
    },
    scales: {
        x: {
            ticks: {
                color: '#cccccc',
                font: {
                    family: 'Share Tech Mono'
                }
            },
            grid: {
                color: 'rgba(0, 255, 255, 0.2)'
            }
        },
        y: {
            ticks: {
                color: '#cccccc',
                font: {
                    family: 'Share Tech Mono'
                }
            },
            grid: {
                color: 'rgba(0, 255, 255, 0.2)'
            }
        }
    },
    elements: {
        point: {
            backgroundColor: '#00ffff',
            borderColor: '#ff00ff'
        }
    }
};

// Daily Revenue Chart
const dailyCtx = document.getElementById('dailyRevenueChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: [{% for date, revenue in daily_revenue.items() %}'{{ date.strftime("%m/%d") }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Daily Revenue',
            data: [{% for date, revenue in daily_revenue.items() %}{{ revenue }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#00ffff',
            backgroundColor: 'rgba(0, 255, 255, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        ...chartOptions,
        responsive: true,
        plugins: {
            ...chartOptions.plugins,
            title: {
                display: true,
                text: 'Revenue Stream Analysis',
                color: '#00ffff',
                font: {
                    family: 'Orbitron',
                    size: 16
                }
            }
        }
    }
});

// Top Performers Chart
const topCtx = document.getElementById('topPerformersChart').getContext('2d');
new Chart(topCtx, {
    type: 'bar',
    data: {
        {% if top_performers %}
        labels: [{% for perf in top_performers[:8] %}'{{ perf.game.name[:12] }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Daily Revenue',
            data: [{% for perf in top_performers[:8] %}{{ "%.2f"|format(perf.daily_revenue) }}{% if not loop.last %},{% endif %}{% endfor %}],
        {% else %}
        labels: ['No Data'],
        datasets: [{
            label: 'Daily Revenue',
            data: [0],
        {% endif %}
            backgroundColor: [
                'rgba(0, 255, 255, 0.8)',
                'rgba(255, 0, 255, 0.8)',
                'rgba(0, 255, 0, 0.8)',
                'rgba(255, 128, 0, 0.8)',
                'rgba(128, 0, 255, 0.8)',
                'rgba(255, 255, 0, 0.8)',
                'rgba(0, 128, 255, 0.8)',
                'rgba(255, 0, 128, 0.8)'
            ],
            borderColor: [
                '#00ffff', '#ff00ff', '#00ff00', '#ff8000', 
                '#8000ff', '#ffff00', '#0080ff', '#ff0080'
            ],
            borderWidth: 2
        }]
    },
    options: {
        ...chartOptions,
        responsive: true,
        plugins: {
            ...chartOptions.plugins,
            title: {
                display: true,
                text: 'Top Revenue Generators',
                color: '#ff00ff',
                font: {
                    family: 'Orbitron',
                    size: 16
                }
            }
        }
    }
});

// Game Status Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for status, count in status_distribution.items() %}'{{ status.replace("_", " ") }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for status, count in status_distribution.items() %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(0, 255, 0, 0.8)',
                'rgba(255, 128, 0, 0.8)', 
                'rgba(255, 0, 0, 0.8)',
                'rgba(128, 128, 128, 0.8)'
            ],
            borderColor: ['#00ff00', '#ff8000', '#ff0000', '#808080'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#00ffff',
                    font: {
                        family: 'Share Tech Mono'
                    }
                }
            },
            title: {
                display: true,
                text: 'System Health Status',
                color: '#00ff00',
                font: {
                    family: 'Orbitron',
                    size: 16
                }
            }
        }
    }
});

// Location Distribution Chart
const locationCtx = document.getElementById('locationChart').getContext('2d');
new Chart(locationCtx, {
    type: 'pie',
    data: {
        labels: [{% for location, count in location_distribution.items() %}'{{ location }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for location, count in location_distribution.items() %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(0, 255, 255, 0.8)',
                'rgba(255, 0, 255, 0.8)',
                'rgba(255, 128, 0, 0.8)'
            ],
            borderColor: ['#00ffff', '#ff00ff', '#ff8000'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#00ffff',
                    font: {
                        family: 'Share Tech Mono'
                    }
                }
            },
            title: {
                display: true,
                text: 'Asset Distribution',
                color: '#ff8000',
                font: {
                    family: 'Orbitron',
                    size: 16
                }
            }
        }
    }
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<h1>üîß Work Order #{{ maintenance.id }}: {{ maintenance.game.name }}</h1>

<div style="background: var(--dark-card); padding: 20px; border-radius: 8px; border: 1px solid var(--neon-cyan); margin-bottom: 30px;">
    <h3>üìã Original Request</h3>
    <p><strong>Reported:</strong> {{ maintenance.date_reported.strftime('%Y-%m-%d %H:%M') }}</p>
    <p><strong>Issue:</strong> {{ maintenance.issue_description }}</p>
    {% if maintenance.fix_description %}
    <p><strong>Current Diagnosis:</strong> {{ maintenance.fix_description }}</p>
    {% endif %}
    {% if maintenance.work_logs %}
    <p><strong>Previous Work Entries:</strong> {{ maintenance.work_logs|length }} entries logged</p>
    <a href="{{ url_for('view_maintenance', maintenance_id=maintenance.id) }}" class="btn" style="background: var(--neon-purple); font-size: 12px; padding: 5px 10px; margin-top: 10px;">üìã View All Work History</a>
    {% endif %}
</div>

<div style="background: var(--dark-card); padding: 20px; border-radius: 8px; border: 1px solid var(--neon-orange); margin-bottom: 20px;">
    <h3 style="color: var(--neon-orange); margin-top: 0;">‚ûï Log New Work Entry</h3>
    <p style="color: var(--text-secondary); margin-bottom: 0;">Each time you update this form, a new timestamped work entry will be created.</p>
</div>

<form method="POST">
    {% if config.WTF_CSRF_ENABLED %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    {% endif %}
    <div class="form-group">
        <label for="status">Current Status *</label>
        <select id="status" name="status" required>
            <option value="Open" {{ 'selected' if maintenance.status == 'Open' else '' }}>Open</option>
            <option value="In_Progress" {{ 'selected' if maintenance.status == 'In_Progress' else '' }}>In Progress</option>
            <option value="Fixed" {{ 'selected' if maintenance.status == 'Fixed' else '' }}>Fixed</option>
            <option value="Deferred" {{ 'selected' if maintenance.status == 'Deferred' else '' }}>Deferred</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="technician">Assigned Technician</label>
        <input type="text" id="technician" name="technician" value="{{ maintenance.technician or '' }}" placeholder="Who is working on this?">
    </div>
    
    <div class="form-group">
        <label for="fix_description">Updated Diagnosis / Assessment</label>
        <textarea id="fix_description" name="fix_description" rows="3" placeholder="Update your diagnosis as you learn more...">{{ maintenance.fix_description or '' }}</textarea>
        <small style="color: var(--text-secondary); font-size: 12px;">Initial assessment - what you think is wrong</small>
    </div>
    
    <div class="form-group">
        <label for="work_notes">Work Description *</label>
        <textarea id="work_notes" name="work_notes" rows="5" placeholder="What work did you perform during this session? Be specific about steps taken, problems found, solutions tried..." required></textarea>
        <small style="color: var(--text-secondary); font-size: 12px;">üìù This will create a new timestamped work log entry</small>
    </div>
    
    <div class="form-group">
        <label for="parts_used">Parts / Materials Used (This Session)</label>
        <textarea id="parts_used" name="parts_used" rows="3" placeholder="List any parts, components, or materials used during this work session..."></textarea>
        <small style="color: var(--text-secondary); font-size: 12px;">üîß Include part numbers, quantities, suppliers if applicable to this work session</small>
    </div>
    
    <!-- Smart Inventory Management Section -->
    <div style="background: var(--dark-card); padding: 20px; border-radius: 8px; border: 1px solid var(--neon-green); margin: 20px 0;">
        <h3 style="color: var(--neon-green); margin-top: 0;">üì¶ Inventory Management</h3>
        <p style="color: var(--text-secondary); margin-bottom: 15px;">Use parts from inventory or request items you need.</p>
        
        <div id="inventory-items">
            <!-- Initial row will be added by JavaScript -->
        </div>
        
        <button type="button" onclick="addInventoryRow()" class="btn" style="background: var(--neon-green); color: black; margin-top: 10px; font-size: 13px;">
            ‚ûï Add Inventory Item
        </button>
        
        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--neon-green); flex-wrap: wrap; gap: 10px;">
            <div>
                <strong style="color: var(--neon-cyan);">Items to Use: <span id="items-to-use-count">0</span></strong>
                <br>
                <strong style="color: var(--neon-purple);">Items to Request: <span id="items-to-request-count">0</span></strong>
            </div>
            <div style="text-align: right;">
                <strong style="color: var(--neon-yellow);">Total Use Cost: <span id="total-use-cost">$0.00</span></strong>
            </div>
        </div>
    </div>
    
    <div class="form-row" style="display: flex; gap: 20px;">
        <div class="form-group" style="flex: 1;">
            <label for="time_spent">Time Spent (Hours)</label>
            <input type="number" id="time_spent" name="time_spent" step="0.25" min="0" placeholder="2.5">
            <small style="color: var(--text-secondary); font-size: 12px;">‚è±Ô∏è How long did this work session take?</small>
        </div>
        
        <div class="form-group" style="flex: 1;">
            <label for="work_cost">Cost for This Work ($)</label>
            <input type="number" id="work_cost" name="work_cost" step="0.01" min="0" placeholder="25.50">
            <small style="color: var(--text-secondary); font-size: 12px;">üí∞ Cost incurred during this specific work session</small>
        </div>
    </div>
    
    <div class="form-group">
        <label for="cost">Update Total Order Cost ($)</label>
        <input type="number" id="cost" name="cost" step="0.01" min="0" value="{{ maintenance.cost or '' }}" placeholder="Total cumulative cost">
        <small style="color: var(--text-secondary); font-size: 12px;">üßæ Overall cost for the entire work order (optional - can be calculated from work entries)</small>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center; margin-top: 20px;">
        <button type="submit" class="btn btn-warning">üìù Log Work Entry</button>
        <a href="{{ url_for('maintenance_orders') }}" class="btn" style="background: #6c757d; color: white; text-decoration: none;">Cancel</a>
        <a href="{{ url_for('game_detail', game_id=maintenance.game_id) }}" class="btn" style="background: var(--neon-cyan); color: black; text-decoration: none;">View Game</a>
    </div>
</form>

<script>
let inventoryRowCount = 0;
const maxInventoryRows = 10;
const inventoryItemsData = {{ inventory_items|tojson|safe }};

function addInventoryRow() {
    if (inventoryRowCount >= maxInventoryRows) {
        alert('Maximum 10 inventory items per work order');
        return;
    }
    
    const index = inventoryRowCount;
    const container = document.getElementById('inventory-items');
    
    const rowDiv = document.createElement('div');
    rowDiv.className = 'inventory-item-row';
    rowDiv.id = `inventory-row-${index}`;
    rowDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 15px; align-items: end; flex-wrap: wrap; padding: 10px; background: rgba(0, 255, 0, 0.05); border-radius: 4px; border: 1px solid rgba(0, 255, 0, 0.2);';
    
    // Build options HTML
    let optionsHTML = '<option value="">-- Select Item --</option>';
    inventoryItemsData.forEach(item => {
        optionsHTML += `<option value="${item.id}" data-stock="${item.stock_quantity}" data-price="${item.unit_price}" data-name="${item.name}">${item.name} (Stock: ${item.stock_quantity})</option>`;
    });
    
    rowDiv.innerHTML = `
        <div style="flex: 2; min-width: 200px;">
            <label for="inventory_item_${index}">Item ${index + 1}</label>
            <select id="inventory_item_${index}" name="inventory_item_${index}" onchange="updateItemInfo(${index})" class="inventory-select">
                ${optionsHTML}
            </select>
        </div>
        <div style="flex: 0.8; min-width: 80px;">
            <label for="inventory_quantity_${index}">Quantity</label>
            <input type="number" id="inventory_quantity_${index}" name="inventory_quantity_${index}" min="0" max="999" placeholder="0" class="inventory-quantity">
        </div>
        <div style="flex: 0.8; min-width: 70px;">
            <label style="font-size: 11px;">Available</label>
            <div id="available_${index}" style="padding: 8px; color: var(--text-secondary); font-size: 12px; text-align: center;">-</div>
        </div>
        <div style="flex: 1; min-width: 100px;">
            <label for="item_action_${index}">Action</label>
            <select id="item_action_${index}" name="item_action_${index}" class="item-action" onchange="updateActionUI(${index})" disabled>
                <option value="">-- Select --</option>
                <option value="use">‚úÖ Use Now</option>
                <option value="request">üìã Request</option>
            </select>
        </div>
        <div style="flex: 0.8; min-width: 80px;">
            <label style="font-size: 11px;">Est. Cost</label>
            <div id="cost_${index}" style="padding: 8px; color: var(--neon-yellow); font-size: 12px; text-align: right;">$0.00</div>
        </div>
        <div id="request_urgency_${index}" style="flex: 1; min-width: 100px; display: none;">
            <label for="urgency_${index}">Urgency</label>
            <select id="urgency_${index}" name="urgency_${index}">
                <option value="Low">Low</option>
                <option value="Normal" selected>Normal</option>
                <option value="High">High</option>
                <option value="Urgent">Urgent</option>
            </select>
        </div>
        <div style="flex: 0; min-width: 40px;">
            <label style="font-size: 11px; opacity: 0;">X</label>
            <button type="button" onclick="removeInventoryRow(${index})" class="btn" style="background: var(--neon-pink); padding: 8px 12px; font-size: 12px;" title="Remove item">
                ‚úï
            </button>
        </div>
    `;
    
    container.appendChild(rowDiv);
    inventoryRowCount++;
}

function removeInventoryRow(index) {
    const row = document.getElementById(`inventory-row-${index}`);
    if (row) {
        row.remove();
        updateTotals();
    }
}

function updateItemInfo(index) {
    const select = document.getElementById(`inventory_item_${index}`);
    const quantityInput = document.getElementById(`inventory_quantity_${index}`);
    const actionSelect = document.getElementById(`item_action_${index}`);
    const availableDiv = document.getElementById(`available_${index}`);
    const costDiv = document.getElementById(`cost_${index}`);
    
    if (select.value) {
        const option = select.selectedOptions[0];
        const stock = parseInt(option.dataset.stock);
        const price = parseFloat(option.dataset.price);
        
        // Update available stock display
        availableDiv.textContent = stock;
        if (stock === 0) {
            availableDiv.style.color = 'var(--neon-pink)';
            availableDiv.textContent = 'Out';
        } else if (stock <= 5) {
            availableDiv.style.color = 'var(--neon-orange)';
        } else {
            availableDiv.style.color = 'var(--neon-green)';
        }
        
        // Enable action dropdown
        actionSelect.disabled = false;
        
        // Update cost calculation when quantity changes
        quantityInput.oninput = function() {
            const quantity = parseInt(this.value) || 0;
            const cost = quantity * price;
            costDiv.textContent = `$${cost.toFixed(2)}`;
            updateTotals();
            
            // Smart suggestion: if quantity > stock, suggest requesting
            const action = document.getElementById(`item_action_${index}`);
            if (quantity > stock && !action.value) {
                action.value = 'request';
                updateActionUI(index);
            } else if (quantity > 0 && quantity <= stock && !action.value) {
                action.value = 'use';
                updateActionUI(index);
            }
        };
        
        // Reset fields
        quantityInput.value = '';
        costDiv.textContent = '$0.00';
        actionSelect.value = '';
    } else {
        // Clear everything
        availableDiv.textContent = '-';
        availableDiv.style.color = 'var(--text-secondary)';
        costDiv.textContent = '$0.00';
        quantityInput.value = '';
        quantityInput.oninput = null;
        actionSelect.value = '';
        actionSelect.disabled = true;
        document.getElementById(`request_urgency_${index}`).style.display = 'none';
    }
    updateTotals();
}

function updateActionUI(index) {
    const action = document.getElementById(`item_action_${index}`).value;
    const urgencyDiv = document.getElementById(`request_urgency_${index}`);
    const quantityInput = document.getElementById(`inventory_quantity_${index}`);
    const select = document.getElementById(`inventory_item_${index}`);
    
    if (action === 'request') {
        urgencyDiv.style.display = 'block';
        // For requests, allow any quantity
        quantityInput.removeAttribute('max');
    } else if (action === 'use') {
        urgencyDiv.style.display = 'none';
        // For using, limit to available stock
        if (select.value) {
            const option = select.selectedOptions[0];
            const stock = parseInt(option.dataset.stock);
            quantityInput.max = stock;
            
            // Validate current quantity
            const currentQty = parseInt(quantityInput.value) || 0;
            if (currentQty > stock) {
                quantityInput.value = stock;
                quantityInput.dispatchEvent(new Event('input'));
            }
        }
    } else {
        urgencyDiv.style.display = 'none';
    }
    updateTotals();
}

function updateTotals() {
    let useCount = 0;
    let requestCount = 0;
    let useCost = 0;
    
    // Check all existing rows
    for (let i = 0; i < inventoryRowCount; i++) {
        const item = document.getElementById(`inventory_item_${i}`);
        const quantityInput = document.getElementById(`inventory_quantity_${i}`);
        const actionSelect = document.getElementById(`item_action_${i}`);
        
        if (item && quantityInput && actionSelect) {
            const quantity = parseInt(quantityInput.value) || 0;
            const action = actionSelect.value;
            
            if (item.value && quantity > 0) {
                if (action === 'use') {
                    useCount++;
                    const option = item.selectedOptions[0];
                    const price = parseFloat(option.dataset.price);
                    useCost += quantity * price;
                } else if (action === 'request') {
                    requestCount++;
                }
            }
        }
    }
    
    document.getElementById('items-to-use-count').textContent = useCount;
    document.getElementById('items-to-request-count').textContent = requestCount;
    document.getElementById('total-use-cost').textContent = `$${useCost.toFixed(2)}`;
}

// Initialize with one empty row on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        addInventoryRow();
    });
} else {
    addInventoryRow();
}
</script>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: var(--neon-cyan);
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px var(--neon-cyan);
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--neon-cyan);
    border-radius: 4px;
    background: var(--dark-card);
    color: var(--text-primary);
    font-family: 'Share Tech Mono', monospace;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--neon-pink);
    box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
}

.form-group small {
    display: block;
    margin-top: 5px;
    font-style: italic;
}

textarea {
    resize: vertical;
    min-height: 60px;
}

.inventory-item-row select,
.inventory-item-row input {
    font-size: 12px;
    padding: 8px;
}

.inventory-item-row label {
    font-size: 12px;
    margin-bottom: 4px;
    color: var(--neon-green);
}

.inventory-select {
    cursor: pointer;
}

.item-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.inventory-quantity:invalid {
    border-color: var(--neon-pink);
}
</style>
{% endblock %}